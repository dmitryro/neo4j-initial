import asyncio
import aiotools
import logging
from bot import logger


class Worker():
    def __init__(self, host='ws://slackbot', port=8765):
        self.host = host
        self.port = port


    async def listen(self, *args, **kwargs):
        approved = await read_approved()
        logger.info(f"WE WERE FINALLY CALLED - {approved}")
        logger.info("WE WERE CALLED=====>")
        print("WE WERE CALLED=====>")

    @aiotools.server
    async def worker_main(self, loop, pidx, args):
        coro = await asyncio.start_server(self.listen, self.host, self.port,
                                          reuse_port=True)
        server = loop.run_until_complete(coro)
        #logger.info(f'[{pidx}] started')
        #yield  # wait until terminated
        #server.close()
        #await server.wait_closed()
        #logger.info(f'[{pidx}] terminated')



    def start(self):

        coro = await asyncio.start_server(self.listen, self.host, self.port,
                                          reuse_port=True)
        server = loop.run_until_complete(coro)




    def stop(self):
        pass            
